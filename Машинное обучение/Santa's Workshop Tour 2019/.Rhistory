cur_epoch_start <- Sys.time()
for (fi in 1:nrow(cur_pred)){
# loop over each family choice
f <- as.character(cur_pred[fi,"family_id"])
fcur_pd <- subset(cur_pd,family_id == f)
fcur_choice <- fcur_pd[1,"cur_choice"]
fcur_day <- fcur_pd[1,"assigned_day"]
fcur_ni <- fcur_pd[1,"n_people"]
fcur_n <- as.character(fcur_ni)
fcur_penalty <- nch[fcur_choice,fcur_n]
#temp_daily_occ
tdo <- cur_daily_occ
tdo[fcur_day] <- tdo[fcur_day]-fcur_ni
f_scores <- sapply(ac,function(pick){
#if(pick == fcur_choice)
#    {return(cur_score)}
#else{
temp_penalty <- cur_penalty - fcur_penalty + nch[pick,fcur_n]
ftemp_day <- fcur_pd[1,paste0("choice_",pick)]
tdo[ftemp_day] <- tdo[ftemp_day]+fcur_ni
temp_acc_cost <- acc_cost(tdo)
temp_score <- temp_penalty + temp_acc_cost
return(temp_score)
#}
})
# update new choice
fnew_choice <- names(which.min(f_scores))
if(f_scores[fnew_choice] < cur_score){
cpff <- which(cur_pd$family_id == f)
cur_pd[cpff,"cur_choice"] <- fnew_choice
fnew_day <- fcur_pd[1,paste0("choice_",fnew_choice)]
cur_pd[cpff,"assigned_day"] <- fnew_day
cur_daily_occ <- tdo
cur_daily_occ[fnew_day] <- cur_daily_occ[fnew_day] + fcur_ni
cur_score <- f_scores[fnew_choice]
cur_penalty <- cur_penalty - fcur_penalty + nch[fnew_choice,fcur_n]
}
#if(cur_score!=cost_function(cur_pd %>% select(family_id,assigned_day))) break()
}
print(paste("epoch:",fn,"; score:",cur_score))
print(Sys.time()-cur_epoch_start)
if(cur_score == cur_epoch_score) break()
cur_epoch_score <- cur_score
}
res <- list()
res[[1]] <- cur_pd %>% select(family_id,assigned_day)
res[[2]] <- cur_score
return(res)
}
set.seed(123)
n <- 5000
m <- 5000
x <- 1:n
n_Fi = sample(x, m, replace=F)
opt_pred_2 <-function(cur_pred,ntimes = 1){
cur_score <- cost_function(cur_pred)
cur_pd <- cur_pred %>% inner_join(data, by = "family_id")
for(fc in 0:9) cur_pd[,paste0("cchoice_",fc)] <- (cur_pd[,paste0("choice_",fc)] == cur_pd[,"assigned_day"])*fc
cur_pd[,"cchoice_10"] <- (rowSums(cur_pd[,paste0("cchoice_",0:9)])==0)*10
cur_pd[cur_pd[,paste0("choice_",0)] == cur_pd[,"assigned_day"],"cchoice_10"] <- 0
cur_pd$cur_choice <- as.character(rowSums(cur_pd[,paste0("cchoice_",0:10)]))
cur_pd$assigned_day <- factor(cur_pred$assigned_day, levels = 1:100,labels = 1:100)
cur_daily_occ <- cur_pd %>% group_by(assigned_day) %>% summarize(s = sum(n_people)) %>% select(s) %>% pull
cur_acc_cost <- acc_cost(cur_daily_occ)
cur_penalty <- cur_score - cur_acc_cost
ac <- as.character(0:9)
# loop ntimes over each family
for(fn in 1:ntimes){
cur_epoch_score <- cur_score
cur_epoch_start <- Sys.time()
for (fi in n_Fi){
# use the random number created above
# loop over each family choice
f <- as.character(cur_pred[fi,"family_id"])
fcur_pd <- subset(cur_pd,family_id == f)
fcur_choice <- fcur_pd[1,"cur_choice"]
fcur_day <- fcur_pd[1,"assigned_day"]
fcur_ni <- fcur_pd[1,"n_people"]
fcur_n <- as.character(fcur_ni)
fcur_penalty <- nch[fcur_choice,fcur_n]
#temp_daily_occ
tdo <- cur_daily_occ
tdo[fcur_day] <- tdo[fcur_day]-fcur_ni
f_scores <- sapply(ac,function(pick){
temp_penalty <- cur_penalty - fcur_penalty + nch[pick,fcur_n]
ftemp_day <- fcur_pd[1,paste0("choice_",pick)]
tdo[ftemp_day] <- tdo[ftemp_day]+fcur_ni
temp_acc_cost <- acc_cost(tdo)
temp_score <- temp_penalty + temp_acc_cost
return(temp_score)
})
# update new choice
f_scores = f_scores[which(cur_score > f_scores)]
fnew_choice <- names(which.max(f_scores))
# optimise f_scores into one better choice at a time
if(length(f_scores)==0){}
else if(f_scores[fnew_choice] < cur_score){
cpff <- which(cur_pd$family_id == f)
cur_pd[cpff,"cur_choice"] <- fnew_choice
fnew_day <- fcur_pd[1,paste0("choice_",fnew_choice)]
cur_pd[cpff,"assigned_day"] <- fnew_day
cur_daily_occ <- tdo
cur_daily_occ[fnew_day] <- cur_daily_occ[fnew_day] + fcur_ni
cur_score <- f_scores[fnew_choice]
cur_penalty <- cur_penalty - fcur_penalty + nch[fnew_choice,fcur_n]
}
}
print(paste("epoch:",fn,"; score:",cur_score))
print(Sys.time()-cur_epoch_start)
if(cur_score == cur_epoch_score) break()
cur_epoch_score <- cur_score
}
res <- list()
res[[1]] <- cur_pd %>% select(family_id,assigned_day)
res[[2]] <- cur_score
return(res)
}
paths=list.files("samples")
for(pth in paths){
fpath = pth
gab = read.csv(paste0(getwd(),"/samples/",fpath))
#gab$assigned_day=sample(1:100,5000,replace = T) %>% matrix(ncol=1)
rownames(gab) <- submission$family_id
opt_gab <- opt_pred_2(gab,1000)
opt_score <- opt_gab[[2]]
print(opt_score)
if(opt_score<70490) write.csv(opt_gab[[1]],file =paste("submission",round(opt_score,2),".csv"),quote = F,row.names = F)
}
paths=list.files("samples")
for(pth in paths){
fpath = pth
gab = read.csv(paste0(getwd(),"/samples/",fpath))
#gab$assigned_day=sample(1:100,5000,replace = T) %>% matrix(ncol=1)
rownames(gab) <- submission$family_id
opt_gab <- opt_pred_2(gab,1000)
opt_score <- opt_gab[[2]]
print(opt_score)
if(opt_score<70490) write.csv(opt_gab[[1]],file =paste("submission",round(opt_score,2),".csv"),quote = F,row.names = F)
}
paths=list.files("samples")
for(pth in paths){
fpath = pth
gab = read.csv(paste0(getwd(),"/samples/",fpath))
#gab$assigned_day=sample(1:100,5000,replace = T) %>% matrix(ncol=1)
rownames(gab) <- submission$family_id
opt_gab <- opt_pred_2(gab,1000)
opt_score <- opt_gab[[2]]
print(opt_score)
if(opt_score<70490) write.csv(opt_gab[[1]],file =paste("submission",round(opt_score,2),".csv"),quote = F,row.names = F)
}
counts=df %>% group_by(ch) %>% summarise(ct=n())
counts
df=data.frame(fam=bes$family_id,ch=factor(choise,levels = c("0","1","2","3","4","5","6","7","8","9","no"),np=factor(peop))) %>% tbl_df()
df=data.frame(fam=bes$family_id,ch=factor(choise,levels = c("0","1","2","3","4","5","6","7","8","9","no")),np=factor(peop)) %>% tbl_df()
counts=df %>% group_by(ch,np) %>% summarise(ct=n())
counts
ggplot(counts,aes(x=ch,y=ct))+
facet_wrap(np)+
geom_col()+
theme_light()
df=data.frame(fam=bes$family_id,ch=factor(choise,levels = c("0","1","2","3","4","5","6","7","8","9","no")),np=factor(peop)) %>% tbl_df()
counts=df %>% group_by(ch,np) %>% summarise(ct=n())
ggplot(counts,aes(x=ch,y=ct))+
facet_wrap(np)+
geom_col()+
theme_light()
counts
ggplot(counts,aes(x=ch,y=ct))+
facet_wrap(vars(np))+
geom_col()+
theme_light()
library(tidyverse)
library(magrittr)
library(compiler)
#options(digits = 17)
data=read_csv("family_data.csv")
peop=data$n_people
choises=data[,2:11]
preference.cost=function(dayvec){
tmp=apply(choises,2,function(x) ifelse(x==dayvec,1,0))
sums=apply(tmp, 1, sum)
sums=ifelse(sums>0,0,1)
(
tmp[,2]*50+
tmp[,3]*(50+9*peop)+
tmp[,4]*(100+9*peop)+
tmp[,5]*(200+9*peop)+
tmp[,6]*(200+18*peop)+
tmp[,7]*(300+18*peop)+
tmp[,8]*(300+36*peop)+
tmp[,9]*(400+36*peop)+
tmp[,10]*(500+(36+199)*peop)+
sums*(500+(36+398)*peop)
) %>% sum()
}
accounting.penalty=function(dayvec){
N=cbind(peop,d=dayvec) %>% tbl_df() %>% mutate(d=factor(d))%>%
group_by(d) %>% summarise(sums=sum(peop)) %$%sums
if(sum(N<125|N>300)>0) {
return(1e20)
}
N2=c(N,N[100])[2:101]
( (N-125)/400*N^(0.5+0.02*abs(N-N2))) %>% sum()
}
score=function(dayvec) preference.cost(dayvec)+accounting.penalty(dayvec)
bes=read_csv("res.csv")
res= bes$assigned_day
resold= read_csv("res.csv")$assigned_day
tt=cbind(1:5000,resold,res,peop,choises)
View(tt)
tt[tt$resold!=tt$res,]
tt=cbind(1:5000,resold,res,peop,choises) %>% tbl_df()
tt %>% filter(resold!=res)
bes=read_csv("res.csv")
res= bes$assigned_day
resold= read_csv("resold.csv")$assigned_day
tt=cbind(1:5000,resold,res,peop,choises) %>% tbl_df()
tt %>% filter(resold!=res)
resold= read_csv("resold.csv")$assigned_day
tt=cbind(1:5000,resold,res,peop,choises) %>% tbl_df()
pp=tt %>% filter(resold!=res)
View(pp)
bes=read_csv("res.csv")
res= bes$assigned_day
resold= read_csv("resold.csv")$assigned_day
tt=cbind(1:5000,resold,res,peop,choises) %>% tbl_df()
pp=tt %>% filter(resold!=res)
View(pp)
View(pp)
ds=data.frame(p=peop,dc=factor(res)) %>% group_by(dc) %>% summarise(val=sum(p))
ggplot(ds,aes(x=dc,y=val))+
geom_col()+
labs(title=paste("acc =",accounting.penalty(res),"  pre =",preference.cost(res)))+
geom_hline(yintercept =c( 125,300),col="red",size=1.5)+
theme_bw()
ds=data.frame(p=peop,dc=factor(res),np=factor(peop)) %>% group_by(dc,np) %>% summarise(val=sum(p))
ggplot(ds,aes(x=dc,y=val))+
geom_col()+
facet_wrap(vars(np))+
labs(title=paste("acc =",accounting.penalty(res),"  pre =",preference.cost(res)))+
geom_hline(yintercept =c( 125,300),col="red",size=1.5)+
theme_bw()
View(pp)
N=ds$val[1:99]
N2=c(N,N[99])[2:100]
rs=( (N-125)/400*N^(0.5+0.02*abs(N-N2)))
rs
ds=data.frame(p=peop,dc=factor(res)) %>% group_by(dc) %>% summarise(val=sum(p))
ggplot(ds,aes(x=dc,y=val))+
geom_col()+
labs(title=paste("acc =",accounting.penalty(res),"  pre =",preference.cost(res)))+
geom_hline(yintercept =c( 125,300),col="red",size=1.5)+
theme_bw()
N=ds$val[1:99]
N2=c(N,N[99])[2:100]
rs=( (N-125)/400*N^(0.5+0.02*abs(N-N2)))
rs
df=data.frame(fam=bes$family_id,ch=factor(choise,levels = c("0","1","2","3","4","5","6","7","8","9","no")),np=factor(peop)) %>% tbl_df()
counts=df %>% group_by(ch,np) %>% summarise(ct=n())
ggplot(counts,aes(x=ch,y=ct))+
facet_wrap(vars(np))+
geom_col()+
theme_light()
bes=read_csv("res.csv")
res= bes$assigned_day
choise=-res
choise[res==choises[1]]=0
choise[res==choises[2]]=1
choise[res==choises[3]]=2
choise[res==choises[4]]=3
choise[res==choises[5]]=4
choise[res==choises[6]]=5
choise[res==choises[7]]=6
choise[res==choises[8]]=7
choise[res==choises[9]]=8
choise[res==choises[10]]=9
choise[choise<0]=-1
which(res==choises[6])
df=data.frame(fam=bes$family_id,ch=factor(choise,levels = c("0","1","2","3","4","5","6","7","8","9","no")),np=factor(peop)) %>% tbl_df()
counts=df %>% group_by(ch,np) %>% summarise(ct=n())
ggplot(counts,aes(x=ch,y=ct))+
facet_wrap(vars(np))+
geom_col()+
theme_light()
counts
View(counts)
View(counts)
21*7/11
21*6/11
21*5/11
15+15+13+8
library(tidyverse)
library(magrittr)
library(compiler)
#options(digits = 17)
data=read_csv("family_data.csv")
peop=data$n_people
choises=data[,2:11]
preference.cost=function(dayvec){
tmp=apply(choises,2,function(x) ifelse(x==dayvec,1,0))
sums=apply(tmp, 1, sum)
sums=ifelse(sums>0,0,1)
(
tmp[,2]*50+
tmp[,3]*(50+9*peop)+
tmp[,4]*(100+9*peop)+
tmp[,5]*(200+9*peop)+
tmp[,6]*(200+18*peop)+
tmp[,7]*(300+18*peop)+
tmp[,8]*(300+36*peop)+
tmp[,9]*(400+36*peop)+
tmp[,10]*(500+(36+199)*peop)+
sums*(500+(36+398)*peop)
) %>% sum()
}
accounting.penalty=function(dayvec){
N=cbind(peop,d=dayvec) %>% tbl_df() %>% mutate(d=factor(d))%>%
group_by(d) %>% summarise(sums=sum(peop)) %$%sums
if(sum(N<125|N>300)>0) {
return(1e20)
}
N2=c(N,N[100])[2:101]
( (N-125)/400*N^(0.5+0.02*abs(N-N2))) %>% sum()
}
score=function(dayvec) preference.cost(dayvec)+accounting.penalty(dayvec)
bes=read_csv("res.csv")
res= bes$assigned_day
choise=-res
choise[res==choises[1]]=0
choise[res==choises[2]]=1
choise[res==choises[3]]=2
choise[res==choises[4]]=3
choise[res==choises[5]]=4
choise[res==choises[6]]=5
choise[res==choises[7]]=6
choise[res==choises[8]]=7
choise[res==choises[9]]=8
choise[res==choises[10]]=9
choise[choise<0]=-1
which(res==choises[6])
df=data.frame(fam=bes$family_id,ch=factor(choise,levels = c("0","1","2","3","4","5","6","7","8","9","no")),np=factor(peop)) %>% tbl_df()
counts=df %>% group_by(ch,np) %>% summarise(ct=n())
ggplot(counts,aes(x=ch,y=ct))+
facet_wrap(vars(np))+
geom_col()+
theme_light()
ds=data.frame(p=peop,dc=factor(res)) %>% group_by(dc) %>% summarise(val=sum(p))
ggplot(ds,aes(x=dc,y=val))+
geom_col()+
labs(title=paste("acc =",accounting.penalty(res),"  pre =",preference.cost(res)))+
geom_hline(yintercept =c( 125,300),col="red",size=1.5)+
theme_bw()
ds=data.frame(p=peop,dc=factor(res),np=factor(peop)) %>% group_by(dc,np) %>% summarise(val=sum(p))
ggplot(ds,aes(x=dc,y=val))+
geom_col()+
facet_wrap(vars(np))+
labs(title=paste("acc =",accounting.penalty(res),"  pre =",preference.cost(res)))+
geom_hline(yintercept =c( 125,300),col="red",size=1.5)+
theme_bw()
df=data.frame(fam=bes$family_id,ch=factor(choise,levels = c("0","1","2","3","4","5","6","7","8","9","no")),np=factor(peop)) %>% tbl_df()
counts=df %>% group_by(ch,np) %>% summarise(ct=n())
ggplot(counts,aes(x=ch,y=ct))+
facet_wrap(vars(np))+
geom_col()+
theme_light()
###
alien=read_table("alien.txt",col_names = T)
View(alien)
alien=data.table::fread("alien.txt",col_names = T)
alien=data.table::fread("alien.txt",col.names = T)
alien=data.table::fread("alien.txt",col.names = T,sep='\t')
alien=data.table::fread("alien.txt",header = T,sep='\t')
View(alien)
rs=alien$assigned_day
score(rs)
resold=rs
resold= read_csv("resold.csv")$assigned_day
tt=cbind(1:5000,resold,res,peop,choises) %>% tbl_df()
pp=tt %>% filter(resold!=res)
View(pp)
View(pp)
res=rs
best.res=rs
res=read_csv("res.csv")
res$assigned_day=best.res
#best.res=res$assigned_day
write_csv(res,"res.csv")
df=data.frame(fam=bes$family_id,ch=factor(choise,levels = c("0","1","2","3","4","5","6","7","8","9","no")),np=factor(peop)) %>% tbl_df()
counts=df %>% group_by(ch,np) %>% summarise(ct=n())
ggplot(counts,aes(x=ch,y=ct))+
facet_wrap(vars(np))+
geom_col()+
theme_light()
counts
bes=read_csv("res.csv")
res= bes$assigned_day
choise=-res
choise[res==choises[1]]=0
choise[res==choises[2]]=1
choise[res==choises[3]]=2
choise[res==choises[4]]=3
choise[res==choises[5]]=4
choise[res==choises[6]]=5
choise[res==choises[7]]=6
choise[res==choises[8]]=7
choise[res==choises[9]]=8
choise[res==choises[10]]=9
choise[choise<0]=-1
which(res==choises[6])
df=data.frame(fam=bes$family_id,ch=factor(choise,levels = c("0","1","2","3","4","5","6","7","8","9","no")),np=factor(peop)) %>% tbl_df()
counts=df %>% group_by(ch,np) %>% summarise(ct=n())
ggplot(counts,aes(x=ch,y=ct))+
facet_wrap(vars(np))+
geom_col()+
theme_light()
counts
ds=data.frame(p=peop,dc=factor(res)) %>% group_by(dc) %>% summarise(val=sum(p))
ggplot(ds,aes(x=dc,y=val))+
geom_col()+
labs(title=paste("acc =",accounting.penalty(res),"  pre =",preference.cost(res)))+
geom_hline(yintercept =c( 125,300),col="red",size=1.5)+
theme_bw()
ds=data.frame(p=peop,dc=factor(res),np=factor(peop)) %>% group_by(dc,np) %>% summarise(val=sum(p))
ggplot(ds,aes(x=dc,y=val))+
geom_col()+
facet_wrap(vars(np))+
labs(title=paste("acc =",accounting.penalty(res),"  pre =",preference.cost(res)))+
geom_hline(yintercept =c( 125,300),col="red",size=1.5)+
theme_bw()
qplot(x=factor(res))
df=data.frame(fam=bes$family_id,ch=factor(choise,levels = c("0","1","2","3","4","5","6","7","8","9","no")),np=factor(peop)) %>% tbl_df()
counts=df %>% group_by(ch,np) %>% summarise(ct=n())
ggplot(counts,aes(x=ch,y=ct))+
facet_wrap(vars(np))+
geom_col()+
theme_light()
counts
choise=-res
choise[res==choises[1]]=0
choise[res==choises[2]]=1
choise[res==choises[3]]=2
choise[res==choises[4]]=3
choise[res==choises[5]]=4
choise[res==choises[6]]=5
choise[res==choises[7]]=6
choise[res==choises[8]]=7
choise[res==choises[9]]=8
choise[res==choises[10]]=9
choise[choise<0]=-1
which(res==choises[6])
df=data.frame(fam=bes$family_id,ch=factor(choise,levels = c("0","1","2","3","4","5","6","7","8","9","no")),np=factor(peop)) %>% tbl_df()
counts=df %>% group_by(ch,np) %>% summarise(ct=n())
ggplot(counts,aes(x=ch,y=ct))+
facet_wrap(vars(np))+
geom_col()+
theme_light()
counts
bes=read_csv("res.csv")
res= bes$assigned_day
choise=-res
choise[res==choises[1]]=0
choise[res==choises[2]]=1
choise[res==choises[3]]=2
choise[res==choises[4]]=3
choise[res==choises[5]]=4
choise[res==choises[6]]=5
choise[res==choises[7]]=6
choise[res==choises[8]]=7
choise[res==choises[9]]=8
choise[res==choises[10]]=9
choise[choise<0]=-1
which(res==choises[6])
df=data.frame(fam=bes$family_id,ch=factor(choise,levels = c("0","1","2","3","4","5","6","7","8","9","no")),np=factor(peop)) %>% tbl_df()
counts=df %>% group_by(ch,np) %>% summarise(ct=n())
ggplot(counts,aes(x=ch,y=ct))+
facet_wrap(vars(np))+
geom_col()+
theme_light()
counts
ds=data.frame(p=peop,dc=factor(res)) %>% group_by(dc) %>% summarise(val=sum(p))
ggplot(ds,aes(x=dc,y=val))+
geom_col()+
labs(title=paste("acc =",accounting.penalty(res),"  pre =",preference.cost(res)))+
geom_hline(yintercept =c( 125,300),col="red",size=1.5)+
theme_bw()
ds=data.frame(p=peop,dc=factor(res),np=factor(peop)) %>% group_by(dc,np) %>% summarise(val=sum(p))
ggplot(ds,aes(x=dc,y=val))+
geom_col()+
facet_wrap(vars(np))+
labs(title=paste("acc =",accounting.penalty(res),"  pre =",preference.cost(res)))+
geom_hline(yintercept =c( 125,300),col="red",size=1.5)+
theme_bw()
ds=data.frame(p=peop,dc=factor(res),np=factor(peop)) %>% group_by(dc,np) %>% summarise(val=sum(p))
ggplot(ds,aes(x=dc,y=val))+
geom_col()+
facet_wrap(vars(np))+
labs(title=paste("acc =",accounting.penalty(res),"  pre =",preference.cost(res)))+
# geom_hline(yintercept =c( 125,300),col="red",size=1.5)+
theme_bw()
resold= read_csv("resold.csv")$assigned_day
tt=cbind(1:5000,resold,res,peop,choises) %>% tbl_df()
pp=tt %>% filter(resold!=res)
View(pp)
View(pp)
resold= read_csv("resold.csv")$assigned_day
tt=cbind(1:5000,resold,res,peop,choises[,1:6]) %>% tbl_df()
pp=tt %>% filter(resold!=res)
View(pp)
resold= read_csv("resold.csv")$assigned_day
tt=cbind(i=1:5000,resold,res,peop,choises[,1:6]) %>% tbl_df()
pp=tt %>% filter(resold!=res)
View(pp)
